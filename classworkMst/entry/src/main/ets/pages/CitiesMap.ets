import router from '@ohos.router';
import { BusinessError } from '@ohos.base';
import { Graph, MSTResult, AnimationStep, GraphEdge } from '../model/GraphPlus';
import { ChinaMapData, TransportType } from '../model/MapData';
import { MapCanvas } from '../componentsPlus/MapCanvas';
import { ControlPanel } from '../componentsPlus/ControlPanel';
import { AlgorithmInfo } from '../componentsPlus/AlgorithmInfo';


@Component
export struct CitiesMap {
  @State transportType: TransportType = TransportType.RAILWAY;
  @State selectedAlgorithm: string = 'prim';
  @State animationSpeed: number = 800;
  @State useTimeWeight: boolean = false;

  @State startNodeIndex: number = 0;

  @State isAnimating: boolean = false;
  @State isPaused: boolean = false;
  @State currentStepIndex: number = -1;
  @State currentStep: AnimationStep | null = null;
  @State mstResult: MSTResult | null = null;
  @State displayedEdges: GraphEdge[] = [];

  private graph: Graph = new Graph();
  private animationTimer: number = -1;

  aboutToAppear() {
    this.initializeGraph();
  }

  aboutToDisappear() {
    this.stopAnimation();
  }

  private initializeGraph() {
    const cityNames = ChinaMapData.getCityNames();
    const matrix = ChinaMapData.getAdjacencyMatrix(this.transportType, this.useTimeWeight);
    this.graph.initialize(cityNames, matrix);
  }

  private startAnimation() {
    this.initializeGraph();

    if (this.selectedAlgorithm === 'prim') {
      this.mstResult = this.graph.primWithAnimation(this.startNodeIndex);
    } else {
      this.mstResult = this.graph.kruskalWithAnimation();
    }

    this.currentStepIndex = -1;
    this.displayedEdges = [];
    this.isAnimating = true;
    this.isPaused = false;
    this.runNextStep();
  }

  private runNextStep() {
    if (!this.mstResult || !this.isAnimating || this.isPaused) return;

    // ä¿®å¤ 1: å…ˆæ£€æŸ¥æ˜¯å¦åˆ°è¾¾æœ€åŽä¸€æ­¥ï¼Œé˜²æ­¢æº¢å‡º
    if (this.currentStepIndex >= this.mstResult.steps.length - 1) {
      this.isAnimating = false;
      return;
    }

    // åªæœ‰æ²¡åˆ°æœ€åŽä¸€æ­¥ï¼Œæ‰å¢žåŠ ç´¢å¼•
    this.currentStepIndex++;

    const step = this.mstResult.steps[this.currentStepIndex];
    this.currentStep = step;

    if (step.type === 'select' && step.edge.from >= 0) {
      let newEdges: GraphEdge[] = [];
      for (let e of this.displayedEdges) {
        newEdges.push(e);
      }
      newEdges.push(step.edge);
      this.displayedEdges = newEdges;
    }

    this.animationTimer = setTimeout(() => {
      this.runNextStep();
    }, this.animationSpeed);
  }

  private pauseAnimation() {
    this.isPaused = true;
    if (this.animationTimer !== -1) {
      clearTimeout(this.animationTimer);
      this.animationTimer = -1;
    }
  }

  private resumeAnimation() {
    this.isPaused = false;
    this.runNextStep();
  }

  private stepForward() {
    if (!this.mstResult) {
      this.initializeGraph();
      if (this.selectedAlgorithm === 'prim') {
        this.mstResult = this.graph.primWithAnimation(this.startNodeIndex);
      } else {
        this.mstResult = this.graph.kruskalWithAnimation();
      }
      this.currentStepIndex = -1;
      this.displayedEdges = [];
    }

    // ä¿®å¤ 2: å•æ­¥æ‰§è¡Œæ—¶ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦å·²æ˜¯æœ€åŽä¸€æ­¥
    if (this.currentStepIndex >= this.mstResult.steps.length - 1) {
      // å·²ç»ç»“æŸäº†ï¼Œç›´æŽ¥è¿”å›žï¼Œä¸å†å¢žåŠ ç´¢å¼•
      return;
    }

    this.currentStepIndex++;

    const step = this.mstResult.steps[this.currentStepIndex];
    this.currentStep = step;
    if (step.type === 'select' && step.edge.from >= 0) {
      let newEdges: GraphEdge[] = [];
      for (let e of this.displayedEdges) {
        newEdges.push(e);
      }
      newEdges.push(step.edge);
      this.displayedEdges = newEdges;
    }
  }

  private resetAnimation() {
    this.stopAnimation();
    this.currentStepIndex = -1;
    this.currentStep = null;
    this.mstResult = null;
    this.displayedEdges = [];
    this.isAnimating = false;
    this.isPaused = false;
  }

  private stopAnimation() {
    if (this.animationTimer !== -1) {
      clearTimeout(this.animationTimer);
      this.animationTimer = -1;
    }
  }

  private openFullScreen() {
    const edgesJson = JSON.stringify(this.displayedEdges);

    router.pushUrl({
      url: 'pages/FullScreenMap',
      params: {
        transportType: this.transportType,
        mstEdgesStr: edgesJson,
        cityNames: ChinaMapData.getCityNames()
      }
    }).catch((err: BusinessError) => {
      console.error(`è·³è½¬å¤±è´¥ code:${err.code}, msg:${err.message}`);
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('ðŸ—ºï¸ äº¤é€šç½‘ç»œæœ€å°ç”Ÿæˆæ ‘')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
      }
      .width('100%')
      .height(56)
      .backgroundColor('#1976D2')
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.Start)

      // ä¸»å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 16 }) {
          // åœ°å›¾åŒºåŸŸ
          Column() {
            MapCanvas({
              mapWidth: 360,
              mapHeight: 450,
              transportType: this.transportType,
              mstEdges: this.displayedEdges,
              currentStep: this.currentStep,
              showAllEdges: true,
              isAnimating: this.isAnimating
            })
          }
          .width('100%')
          .padding(8)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({ radius: 8, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 2 })
          .onClick(() => {
            this.openFullScreen();
          })

          // ç®—æ³•ä¿¡æ¯é¢æ¿
          AlgorithmInfo({
            algorithmName: this.selectedAlgorithm === 'prim' ? 'Prim' : 'Kruskal',
            currentStep: this.currentStep,
            // ä¿®å¤ 3 (å¯é€‰): å¦‚æžœä½ éžå¸¸ä»‹æ„æœ€åŽé‚£ä¸ª"å®Œæˆ"æ­¥éª¤å¯¼è‡´æ€»æ•°+1ï¼Œ
            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤º totalSteps - 1ï¼Œä½†è¿™ä¼šå¯¼è‡´è¿›åº¦æ¡æœ€åŽä¸€æ®µèµ°ä¸æ»¡ã€‚
            // å»ºè®®ä¿ç•™åŽŸå§‹æ€»æ•°ï¼Œå› ä¸º"å®Œæˆ"ä¹Ÿæ˜¯ä¸€ä¸ªæ˜Žç¡®çš„çŠ¶æ€ã€‚
            totalSteps: this.mstResult ? this.mstResult.steps.length : 0,
            currentStepIndex: this.currentStepIndex,
            mstEdges: this.displayedEdges,
            totalCost: this.displayedEdges.reduce((sum, e) => sum + e.weight, 0),
            cityNames: ChinaMapData.getCityNames()
          })

          // æŽ§åˆ¶é¢æ¿
          ControlPanel({
            transportType: $transportType,
            selectedAlgorithm: $selectedAlgorithm,
            animationSpeed: $animationSpeed,
            useTimeWeight: $useTimeWeight,

            startNodeIndex: $startNodeIndex,
            cityNames: ChinaMapData.getCityNames(),

            isAnimating: this.isAnimating,
            isPaused: this.isPaused,

            onStartAnimation: (): void => {
              if (this.isPaused) this.resumeAnimation();
              else this.startAnimation();
            },
            onPauseAnimation: (): void => this.pauseAnimation(),
            onResetAnimation: (): void => this.resetAnimation(),
            onStepForward: (): void => this.stepForward(),
            onOpenFullScreen: (): void => this.openFullScreen()
          })
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor('#F0F4F8')
    }
    .width('100%')
    .height('100%')
  }
}